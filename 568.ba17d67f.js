(self.webpackChunknmemonica=self.webpackChunknmemonica||[]).push([["568"],{2342:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return w}});var a=s("10327"),n=s("58093"),r=s("78615"),i=s("83169"),c=s("40432"),l=s("37654"),o=s("28733"),u=s("80130"),d=s("43398"),h=s("24794"),p=s("22839"),v=s("80486"),m=s("9871"),f=s("16332"),b=s("34616"),x=s("38354"),S=s("72530"),j=s("87177"),y=s("84193"),g=s("93781");function w(){let e=(0,c.useDispatch)(),{localServiceURL:t,lastImport:s}=(0,c.useSelector)(({global:e})=>e),[w,k]=(0,i.useState)(!1),[E,C]=(0,i.useState)(!1),[N,D]=(0,i.useState)(!1),P=(0,i.useRef)(t),{registerCB:V}=(0,v.useSubscribe)(e,P),L=(0,i.useCallback)(()=>{if(!confirm("User edited datasets will be overwritten"))return;let s=(0,o.getExternalSourceType)(t);s===o.ExternalSourceType.Unset?e((0,m.setLocalDataEdited)(!1)):e((0,m.setLocalDataEdited)(!0)),e((0,j.importDatasets)()).unwrap().then(t=>Promise.all(t.map(t=>{let{data:s,hash:a}=(0,h.sheetDataToJSON)(t),n=t.name.toLowerCase();return e((0,y.setVersion)({name:n,hash:a})),(0,p.swMessageSaveDataJSON)(u.dataServiceEndpoint+"/"+n+".json.v"+a,s,a).then(()=>t)})).then(t=>((0,d.openIDB)().then(e=>(0,d.putIDBItem)({db:e,store:d.IDBStores.WORKBOOK},{key:"0",workbook:t})),e((0,y.setSwVersions)())))).then(()=>{e((0,g.clearVocabulary)()),e((0,S.clearPhrases)()),e((0,f.clearKanji)()),e((0,x.clearParticleGame)()),e((0,b.clearOpposites)()),D(!0),e((0,m.setLastImport)(`${["Reset","Local","GitHub"][s]}: ${new Date().toJSON()}`))})},[e,t]),O=(0,i.useCallback)(e=>{k(e)},[]),T=(0,i.useCallback)(e=>{C(e),!e&&D(null)},[]);return(0,a.jsx)("div",{className:"outer",children:(0,a.jsxs)("div",{className:"d-flex flex-column flex-sm-row justify-content-between",children:[(0,a.jsx)("div",{className:"column-1 mb-2 me-sm-2",children:(0,a.jsx)("div",{className:"mt-2 mb-2",children:[(0,a.jsx)("div",{children:"Recent import history:"},"label"),...s.map(e=>(0,a.jsx)("div",{className:"pt-1",children:e},e))]})}),(0,a.jsxs)("div",{className:"column-2",children:[(0,a.jsx)("div",{className:"mb-2",children:(0,a.jsx)(o.default,{onChangeInput:O,onChangeTrust:T})}),(0,a.jsxs)("div",{className:"d-flex",children:[(0,a.jsx)("div",{className:"px-1",children:(0,a.jsxs)(n.Button,{variant:"outlined",size:"small",disabled:w||""===t||!0!==E||!0===N,onClick:L,children:[N?(0,a.jsx)(r.CheckCircleIcon,{size:"small",className:"pe-1"}):(0,a.jsx)(r.DownloadIcon,{size:"small",className:"pe-1"}),"Import"]})}),(0,a.jsx)("div",{className:"px-1",children:(0,a.jsx)(n.Button,{variant:"contained",size:"small",disabled:w||""===t||!E,children:(0,a.jsxs)(l.Link,{to:"/sheet",className:"text-decoration-none",children:["Edit ",(0,a.jsx)(r.UndoIcon,{})]})})}),(0,a.jsx)("div",{className:"px-1",children:(0,a.jsx)(n.Button,{variant:"outlined",onClick:V,size:"small",disabled:w||""===t||!E,children:"Subscribe"})})]})]})]})})}},80486:function(e,t,s){"use strict";s.r(t),s.d(t,{useSubscribe:function(){return c}});var a=s("83169"),n=s("80130"),r=s("9871"),i=s("40665");function c(e,t){let s=(0,a.useCallback)(()=>{let s=t.current;navigator.serviceWorker.ready.then(t=>{t.pushManager.getSubscription().then(async e=>{if(e)return e;let a=await fetch(s+n.pushServicePubKeyPath),r=await a.text(),i=function(e){for(var t="=".repeat((4-e.length%4)%4),s=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),a=window.atob(s),n=new Uint8Array(a.length),r=0;r<a.length;++r)n[r]=a.charCodeAt(r);return n}(r);return t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:i})}).then(e=>{fetch(s+n.pushServiceRegisterClientPath,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify({subscription:e})})}).catch(t=>{e((0,r.logger)("Push API: "+t.message,i.DebugLevel.ERROR))})})},[e,t]);return{registerCB:s}}},87177:function(e,t,s){"use strict";s.r(t),s.d(t,{importDatasets:function(){return p},getDatasets:function(){return m}});var a=s("71387"),n=s("16332"),r=s("72530"),i=s("93781"),c=s("80130"),l=s("84209"),o=s("24794"),u=s("28733");class d extends EventTarget{line(e){this.dispatchEvent(new CustomEvent("line",{detail:e}))}close(e){this.dispatchEvent(new CustomEvent("close",{detail:e}))}on(e,t){let s=e=>{if("detail"in e&&"string"==typeof e.detail){let{detail:s}=e;return t(s)}return t("")};switch(e){case"line":this.addEventListener("line",s);break;case"close":this.addEventListener("close",s)}}}function h(e,t){let s=t.slice(0,t.indexOf("."));return fetch(e+t).then(e=>{if(!e.ok)throw Error("bad response?");return e.text()}).then(e=>{let t=new d;t.addEventListener("line",()=>{});let a=(0,l.csvToObject)(t,s),n=e.includes("\r\n")?"\r\n":"\n";return e.split(n).forEach(e=>{t.line(e)}),t.close(),a})}let p=(0,a.createAsyncThunk)("sheet/importDatasets",async(e,t)=>{let s;let a=t.getState(),n=(0,u.getExternalSourceType)(a.global.localServiceURL),r=a.global.localServiceURL;switch(n){case u.ExternalSourceType.GitHubUserContent:s=Promise.all([h(r+"/","Phrases.csv"),h(r+"/","Vocabulary.csv"),h(r+"/","Kanji.csv")]);break;case u.ExternalSourceType.LocalService:s=fetch(r+c.sheetServicePath).then(e=>e.json()).then(e=>e);break;default:s=v(t.dispatch)}return s});function v(e){let t=e((0,i.getVocabulary)()).unwrap(),s=e((0,r.getPhrase)()).unwrap(),a=e((0,n.getKanji)()).unwrap(),c=["Phrases","Vocabulary","Kanji"];return Promise.all([s,t,a]).then(e=>e.reduce((e,{value:t},s)=>[...e,(0,o.jtox)(t,c[s])],[]))}let m=(0,a.createAsyncThunk)("sheet/getDatasets",async(e,t)=>v(t.dispatch)),f=(0,a.createSlice)({name:"sheet",initialState:{},reducers:{}}),{}=f.actions;f.reducer},84193:function(e,t,s){"use strict";s.r(t),s.d(t,{getVersions:function(){return i},setSwVersions:function(){return c},setVersion:function(){return u},default:function(){return d}});var a=s("71387"),n=s("80130"),r=s("22839");let i=(0,a.createAsyncThunk)("version/getVersions",async(e,t)=>fetch(n.dataServiceEndpoint+"/cache.json").then(e=>e.json())),c=(0,a.createAsyncThunk)("version/setSwVersions",async(e,t)=>{let s=t.getState(),a={...s.version},i=n.dataServiceEndpoint+"/cache.json";return(0,r.swMessageSaveDataJSON)(i,a,"")}),l=(0,a.createSlice)({name:"version",initialState:{vocabulary:void 0,phrases:void 0,kanji:void 0,opposites:void 0,particles:void 0,suffixes:void 0},reducers:{clearVersions(e){e.vocabulary=void 0,e.phrases=void 0,e.kanji=void 0,e.opposites=void 0,e.particles=void 0,e.suffixes=void 0},setVersion(e,t){let{name:s,hash:a}=t.payload;e[s]=a}},extraReducers:e=>{e.addCase(i.fulfilled,(e,t)=>{let{vocabulary:s,kanji:a,phrases:n,opposites:r,particles:i,suffixes:c}=t.payload;e.kanji=a,e.vocabulary=s,e.phrases=n,e.opposites=r,e.particles=i,e.suffixes=c})}}),{clearVersions:o,setVersion:u}=l.actions;var d=l.reducer}}]);