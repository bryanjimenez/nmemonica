(self.webpackChunknmemonica=self.webpackChunknmemonica||[]).push([["568"],{2342:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return y}});var r=n("10327"),s=n("58093"),a=n("78615"),i=n("83169"),l=n("40432"),o=n("37654"),c=n("28733"),u=n("80130"),d=n("43398"),p=n("66968"),h=n("22839"),f=n("80486"),g=n("9871"),b=n("16332"),j=n("34616"),m=n("38354"),v=n("72530"),x=n("87177"),w=n("84193"),k=n("93781");function y(){let e=(0,l.useDispatch)(),{localServiceURL:t,lastImport:n}=(0,l.useSelector)(({global:e})=>e),[y,S]=(0,i.useState)(!1),[E,O]=(0,i.useState)(!1),[N,C]=(0,i.useState)(!1),P=(0,i.useRef)(t),{registerCB:D}=(0,f.useSubscribe)(e,P),G=(0,i.useCallback)(()=>{if(!confirm("User edited datasets will be overwritten"))return;let n=(0,c.getExternalSourceType)(t);n===c.ExternalSourceType.Unset?e((0,g.setLocalDataEdited)(!1)):e((0,g.setLocalDataEdited)(!0)),e((0,x.importDatasets)()).unwrap().then(t=>Promise.all(t.map(t=>{let{data:n,hash:r}=(0,p.sheetDataToJSON)(t),s=t.name.toLowerCase();return e((0,w.setVersion)({name:s,hash:r})),(0,h.swMessageSaveDataJSON)(u.dataServiceEndpoint+"/"+s+".json.v"+r,n,r).then(()=>t)})).then(t=>((0,d.openIDB)().then(e=>(0,d.putIDBItem)({db:e,store:d.IDBStores.WORKBOOK},{key:"0",workbook:t})),e((0,w.setSwVersions)())))).then(()=>{e((0,k.clearVocabulary)()),e((0,v.clearPhrases)()),e((0,b.clearKanji)()),e((0,m.clearParticleGame)()),e((0,j.clearOpposites)()),C(!0),e((0,g.setLastImport)(`${["Reset","Local","GitHub"][n]}: ${new Date().toJSON()}`))})},[e,t]),L=(0,i.useCallback)(e=>{S(e)},[]),T=(0,i.useCallback)(e=>{O(e),!e&&C(null)},[]);return(0,r.jsx)("div",{className:"outer",children:(0,r.jsxs)("div",{className:"d-flex flex-column flex-sm-row justify-content-between",children:[(0,r.jsx)("div",{className:"column-1 mb-2 me-sm-2",children:(0,r.jsx)("div",{className:"mt-2 mb-2",children:[(0,r.jsx)("div",{children:"Recent import history:"},"label"),...n.map(e=>(0,r.jsx)("div",{className:"pt-1",children:e},e))]})}),(0,r.jsxs)("div",{className:"column-2",children:[(0,r.jsx)("div",{className:"mb-2",children:(0,r.jsx)(c.default,{onChangeInput:L,onChangeTrust:T})}),(0,r.jsxs)("div",{className:"d-flex",children:[(0,r.jsx)("div",{className:"px-1",children:(0,r.jsxs)(s.Button,{variant:"outlined",size:"small",disabled:y||""===t||!0!==E||!0===N,onClick:G,children:[N?(0,r.jsx)(a.CheckCircleIcon,{size:"small",className:"pe-1"}):(0,r.jsx)(a.DownloadIcon,{size:"small",className:"pe-1"}),"Import"]})}),(0,r.jsx)("div",{className:"px-1",children:(0,r.jsx)(s.Button,{variant:"contained",size:"small",disabled:y||""===t||!E,children:(0,r.jsxs)(o.Link,{to:"/sheet",className:"text-decoration-none",children:["Edit ",(0,r.jsx)(a.UndoIcon,{})]})})}),(0,r.jsx)("div",{className:"px-1",children:(0,r.jsx)(s.Button,{variant:"outlined",onClick:D,size:"small",disabled:y||""===t||!E,children:"Subscribe"})})]})]})]})})}},42162:function(e,t,n){"use strict";n.r(t),n.d(t,{csvToObject:function(){return s},objectToCSV:function(){return a}});let r=new RegExp(/^,*$/);function s(e,t,n){let{delimiter:s=",",name:a}=n??{};return new Promise((n,i)=>{try{let i={name:a??t,rows:{len:0}},l=0,o="";e.on("line",e=>{let t=e;if(r.test(t))return i.rows[l]={cells:{}},l++,i;if(e.includes('"')&&(e.split('"').length+1)%2!=0&&""===o)return o+=t,i;if(e.includes('"')&&(e.split('"').length+1)%2==0&&""!==o)return o+="\n"+t,i;if(!e.includes('"')&&""!==o)return o+="\n"+t,i;else e.includes('"')&&(e.split('"').length+1)%2!=0&&""!==o&&(t=o+"\n"+t,o="");let n=function(e,t){let n="",r=!1,s={},a=0,i=e.replaceAll('""',"\x02");return i.split("").forEach((e,l)=>{switch(!0){case e===t&&!r:n.length>0&&(s={...s,[a]:{text:n}},n=""),a++;break;case e===t&&r:n+=e;break;case'"'===e:r=!r;break;case"\x02"===e:n+='"';break;default:n+=e}l===i.length-1&&""!==n&&(s={...s,[a]:{text:n}})}),{cells:s}}(t,s);return i.rows[l]=n,i.rows.len=l+1,l++,i}),e.on("close",()=>{n(i)})}catch(e){i(e)}})}function a(e,t,n){let{delimiter:r=","}=n??{},s=0,a=Object.values(e.rows);a.forEach((e,n)=>{let a="";if("number"!=typeof e&&"cells"in e){let i=Object.keys(e.cells).reduce((e,t)=>e<Number(t)?Number(t):e,0);0===n&&(s=i),0===i&&(a=",".repeat(s));for(let t=0;t<i+1;t++){let n=e.cells[t]?.text;switch(!0){case n?.includes(r)||n?.includes("\n")||n?.includes('"'):a+='"'+n?.replaceAll('"','""')+'"';break;case void 0!==n:a+=n}t!==i&&(a+=",")}""!==a&&i<s&&(a+=",".repeat(s-i)),t.write(a+"\r\n")}}),t.end()}},66968:function(e,t,n){"use strict";n.r(t),n.d(t,{jtox:function(){return u},sheetDataToJSON:function(){return d}});var r=n("80335"),s=n.n(r);let a={english:["English"],japanese:["Japanese"],romaji:["Romaji"],grp:["Group"],subGrp:["Sub Group","Subgroup"],tag:["Tags"],pronounce:["Pronounced","Pronounce","Pronunciation"],lit:["Literal"],lesson:["Lesson"],kanji:["Kanji"],on:["Onyomi"],kun:["Kunyomi"],radex:["Radical Examples","Radex"]},i={japanese:-1,romaji:-1,english:-1,grp:-1,subGrp:-1,lit:-1,lesson:-1,tag:-1},l={japanese:-1,romaji:-1,english:-1,grp:-1,subGrp:-1,pronounce:-1,tag:-1},o={kanji:-1,english:-1,on:-1,kun:-1,grp:-1,tag:-1,radex:-1};function c(e){let t=Object.values(e.rows).reduce((e,t)=>{if("number"!=typeof t&&t.cells&&Object.keys(t.cells).length>0){let n=Object.keys(t.cells).map(e=>Number(e)),r=n.reduce((e,n)=>{let{text:r}=t.cells[n];return void 0!==r&&(e[Number(n)]=r),e},Array(n.length));e=[...e,r]}return e},[]);return t}function u(e,t){let n;let r={name:t,rows:{len:0}};switch(t){case"Vocabulary":n={...l};break;case"Phrases":n={...i};break;case"Kanji":n={...o};break;default:throw Error(`Mapping for ${t} not implemented`)}let s=Object.keys(n);s.forEach((e,t)=>{r.rows[0]={cells:{...r.rows[0]?.cells??{},[t]:{text:a[e][0]}}}});let c=1;for(let[t,n]of Object.entries(e)){for(let[e,t]of Object.entries(n)){let n=s.indexOf(e);n>-1&&((!r.rows[c]||!r.rows[c].cells)&&(r.rows[c]={cells:{}}),"string"==typeof t&&(r.rows[c].cells[n]={text:t}))}c++}return r.rows.len=c,r}function d(e){let t={},n="";switch(e.name){case"Vocabulary":{let{vocabularyAfter:r,hash:a}=function(e){let t=c(e);return function(e,t){let n={...l},r=t.reduce((t,r,a)=>{if(0===a&&r.forEach((e,t)=>{p(n,e,t)}),n.english<0||n.japanese<0||n.romaji<0||n.grp<0||n.subGrp<0||n.tag<0||n.pronounce<0){let t=Object.entries(n),r=t.findIndex(([e,t])=>t<0);throw Error(`Missing or incorrect header '${t[r][0]}' in ${e}.csv`)}if(a>0){let i={japanese:r[n.japanese],romaji:r[n.romaji],english:r[n.english]};if(!i.japanese)throw Error(`Missing first cell [1,${a+1}] in ${e}`);let l=s(i.japanese);r[n.grp]&&""!==r[n.grp]&&(i.grp=r[n.grp]),r[n.subGrp]&&""!==r[n.subGrp]&&(i.subGrp=r[n.subGrp]),r[n.pronounce]&&""!==r[n.pronounce]&&(i.pronounce=r[n.pronounce]),r[n.tag]&&""!==r[n.tag]&&(i.tag=r[n.tag]),r[n.romaji]&&""!==r[n.romaji]&&(i.romaji=r[n.romaji]),t[l]=i}return t},{}),a=s(JSON.stringify(r)).slice(0,4);return{hash:a,vocabularyAfter:r}}(e.name,t)}(e);t=r,n=a;break}case"Phrases":{let{phrasesAfter:r,hash:a}=function(e){let t=c(e);return function(e,t){let n={...i},r=t.reduce((t,r,a)=>{if(0===a&&r.forEach((e,t)=>{p(n,e,t)}),n.english<0||n.japanese<0||n.romaji<0||n.grp<0||n.subGrp<0||n.tag<0||n.lit<0||n.lesson<0){let t=Object.entries(n),r=t.findIndex(([e,t])=>t<0);throw Error(`Missing or incorrect header '${t[r][0]}' in ${e}.csv`)}if(a>0){let i={japanese:r[n.japanese],english:r[n.english]};if(!i.japanese)throw Error(`Missing first cell [1,${a+1}] in ${e}`);let l=s(i.japanese);r[n.lit]&&""!==r[n.lit]&&(i.lit=r[n.lit]),r[n.grp]&&""!==r[n.grp]&&(i.grp=r[n.grp]),r[n.subGrp]&&""!==r[n.subGrp]&&(i.subGrp=r[n.subGrp]),r[n.romaji]&&""!==r[n.romaji]&&(i.romaji=r[n.romaji]),r[n.lesson]&&""!==r[n.lesson]&&(i.lesson=r[n.lesson]),r[n.tag]&&""!==r[n.tag]&&(i.tag=r[n.tag]),t[l]=i}return t},{}),a=s(JSON.stringify(r)).slice(0,4);return{hash:a,phrasesAfter:r}}(e.name,t)}(e);t=r,n=a;break}case"Kanji":{let{kanjiList:r,hash:a}=function(e){let t=c(e);return function(e,t){let n={...o},r=t.reduce((t,r,a)=>{if(0===a&&r.forEach((e,t)=>{p(n,e,t)}),n.english<0||n.kanji<0||n.on<0||n.kun<0||n.grp<0||n.tag<0||n.radex<0){let t=Object.entries(n),r=t.findIndex(([e,t])=>t<0);throw Error(`Missing or incorrect header '${t[r][0]}' in ${e}.csv`)}if(a>0){let i={kanji:r[n.kanji],english:r[n.english]};if(!i.kanji)throw console.log("kanji"),Error(`Missing first cell [1,${a+1}] in ${e}`);let l=s(i.kanji);r[n.on]&&""!==r[n.on]&&(i.on=r[n.on]),r[n.kun]&&""!==r[n.kun]&&(i.kun=r[n.kun]),r[n.grp]&&""!==r[n.grp]&&(i.grp=r[n.grp]),r[n.tag]&&""!==r[n.tag]&&(i.tag=r[n.tag]),r[n.radex]&&""!==r[n.radex]&&(i.radex=r[n.radex]),t[l]=i}return t},{}),a=s(JSON.stringify(r)).slice(0,4);return{hash:a,kanjiList:r}}(e.name,t)}(e);t=r,n=a}}return{data:t,hash:n}}function p(e,t,n){let r=t.toLowerCase(),s=Object.entries(a);if(r&&r.length>0){let t=s.findIndex(([e,t])=>void 0!==t.find(e=>e.toLowerCase()===r));-1!==t&&(e[s[t][0]]=n)}}},80486:function(e,t,n){"use strict";n.r(t),n.d(t,{useSubscribe:function(){return l}});var r=n("83169"),s=n("80130"),a=n("9871"),i=n("40665");function l(e,t){let n=(0,r.useCallback)(()=>{let n=t.current;navigator.serviceWorker.ready.then(t=>{t.pushManager.getSubscription().then(async e=>{if(e)return e;let r=await fetch(n+s.pushServicePubKeyPath),a=await r.text(),i=function(e){for(var t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),r=window.atob(n),s=new Uint8Array(r.length),a=0;a<r.length;++a)s[a]=r.charCodeAt(a);return s}(a);return t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:i})}).then(e=>{fetch(n+s.pushServiceRegisterClientPath,{method:"post",headers:{"Content-type":"application/json"},body:JSON.stringify({subscription:e})})}).catch(t=>{e((0,a.logger)("Push API: "+t.message,i.DebugLevel.ERROR))})})},[e,t]);return{registerCB:n}}},87177:function(e,t,n){"use strict";n.r(t),n.d(t,{importDatasets:function(){return h},getDatasets:function(){return g}});var r=n("71387"),s=n("16332"),a=n("72530"),i=n("93781"),l=n("80130"),o=n("42162"),c=n("66968"),u=n("28733");class d extends EventTarget{line(e){this.dispatchEvent(new CustomEvent("line",{detail:e}))}close(e){this.dispatchEvent(new CustomEvent("close",{detail:e}))}on(e,t){let n=e=>{if("detail"in e&&"string"==typeof e.detail){let{detail:n}=e;return t(n)}return t("")};switch(e){case"line":this.addEventListener("line",n);break;case"close":this.addEventListener("close",n)}}}function p(e,t){let n=t.slice(0,t.indexOf("."));return fetch(e+t).then(e=>{if(!e.ok)throw Error("bad response?");return e.text()}).then(e=>{let t=new d;t.addEventListener("line",()=>{});let r=(0,o.csvToObject)(t,n),s=e.includes("\r\n")?"\r\n":"\n";return e.split(s).forEach(e=>{t.line(e)}),t.close(),r})}let h=(0,r.createAsyncThunk)("sheet/importDatasets",async(e,t)=>{let n;let r=t.getState(),s=(0,u.getExternalSourceType)(r.global.localServiceURL),a=r.global.localServiceURL;switch(s){case u.ExternalSourceType.GitHubUserContent:n=Promise.all([p(a+"/","Phrases.csv"),p(a+"/","Vocabulary.csv"),p(a+"/","Kanji.csv")]);break;case u.ExternalSourceType.LocalService:n=fetch(a+l.sheetServicePath).then(e=>e.json()).then(e=>e);break;default:n=f(t.dispatch)}return n});function f(e){let t=e((0,i.getVocabulary)()).unwrap(),n=e((0,a.getPhrase)()).unwrap(),r=e((0,s.getKanji)()).unwrap(),l=["Phrases","Vocabulary","Kanji"];return Promise.all([n,t,r]).then(e=>e.reduce((e,{value:t},n)=>[...e,(0,c.jtox)(t,l[n])],[]))}let g=(0,r.createAsyncThunk)("sheet/getDatasets",async(e,t)=>f(t.dispatch)),b=(0,r.createSlice)({name:"sheet",initialState:{},reducers:{}}),{}=b.actions;b.reducer},84193:function(e,t,n){"use strict";n.r(t),n.d(t,{getVersions:function(){return i},setSwVersions:function(){return l},setVersion:function(){return u},default:function(){return d}});var r=n("71387"),s=n("80130"),a=n("22839");let i=(0,r.createAsyncThunk)("version/getVersions",async(e,t)=>fetch(s.dataServiceEndpoint+"/cache.json").then(e=>e.json())),l=(0,r.createAsyncThunk)("version/setSwVersions",async(e,t)=>{let n=t.getState(),r={...n.version},i=s.dataServiceEndpoint+"/cache.json";return(0,a.swMessageSaveDataJSON)(i,r,"")}),o=(0,r.createSlice)({name:"version",initialState:{vocabulary:void 0,phrases:void 0,kanji:void 0,opposites:void 0,particles:void 0,suffixes:void 0},reducers:{clearVersions(e){e.vocabulary=void 0,e.phrases=void 0,e.kanji=void 0,e.opposites=void 0,e.particles=void 0,e.suffixes=void 0},setVersion(e,t){let{name:n,hash:r}=t.payload;e[n]=r}},extraReducers:e=>{e.addCase(i.fulfilled,(e,t)=>{let{vocabulary:n,kanji:r,phrases:s,opposites:a,particles:i,suffixes:l}=t.payload;e.kanji=r,e.vocabulary=n,e.phrases=s,e.opposites=a,e.particles=i,e.suffixes=l})}}),{clearVersions:c,setVersion:u}=o.actions;var d=o.reducer}}]);